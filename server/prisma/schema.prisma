generator client {
  provider = "prisma-client-js"
}

generator kysely {
  provider     = "prisma-kysely"
  output       = "../src/db"
  fileName     = "types.ts"
  enumFileName = "enums.ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String?
  permissions Json
  isBuiltIn   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model User {
  id                    String                   @id @default(uuid())
  email                 String                   @unique
  password              String
  name                  String
  role                  String                   @default("staff")
  isActive              Boolean                  @default(true)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  mustChangePassword    Boolean                  @default(false)
  roleId                String?
  tokenVersion          Int                      @default(0)
  userRole              Role?                    @relation(fields: [roleId], references: [id])
  permissionOverrides   UserPermissionOverride[]
  gridPreferences       UserGridPreference[]
  inventoryTransactions InventoryTransaction[]
  fabricTransactions    FabricTransaction[]
  returnStatusHistory   ReturnStatusHistory[]
  processedRepackItems  RepackingQueueItem[]     @relation("RepackingProcessor")
  createdWriteOffs      WriteOffLog[]            @relation("WriteOffCreator")
  rtoInwardedLines      OrderLine[]              @relation("RtoInwardedBy")
  customizedLines       OrderLine[]              @relation("CustomizedBy")
  recordedPayments      OrderPayment[]           // Payments recorded by this user

  @@index([roleId])
}

model UserPermissionOverride {
  id         String   @id @default(uuid())
  userId     String
  permission String
  granted    Boolean
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([userId])
}

model UserGridPreference {
  id             String    @id @default(uuid())
  userId         String
  gridId         String
  visibleColumns String    // JSON array of visible column IDs
  columnOrder    String    // JSON array of column IDs in display order
  columnWidths   String    // JSON object of columnId -> width mappings
  adminVersion   DateTime? // Tracks which admin defaults user has acknowledged
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gridId])
  @@index([userId])
  @@index([gridId])
}

model Product {
  id                       String      @id @default(uuid())
  name                     String
  styleCode                String?     @unique
  category                 String
  productType              String
  gender                   String      @default("unisex")
  fabricTypeId             String?
  baseProductionTimeMins   Int         @default(60)
  defaultFabricConsumption Float?
  imageUrl                 String?
  isActive                 Boolean     @default(true)
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt
  shopifyProductId         String?     @unique
  shopifyHandle            String?
  exchangeCount            Int         @default(0)
  returnCount              Int         @default(0)
  writeOffCount            Int         @default(0)
  trimsCost                Float?
  packagingCost            Float?
  liningCost               Float?
  shopifyProductIds        String[]    @default([])
  fabricType               FabricType? @relation(fields: [fabricTypeId], references: [id])
  variations               Variation[]
  bomTemplates             ProductBomTemplate[] // NEW: BOM structure for this product

  @@index([fabricTypeId])
  @@index([category])
  @@index([shopifyHandle])
  @@index([name])
}

model Variation {
  id                     String  @id @default(uuid())
  productId              String
  colorName              String
  standardColor          String?
  colorHex               String?
  fabricId               String
  imageUrl               String?
  isActive               Boolean @default(true)
  hasLining              Boolean @default(false)
  trimsCost              Float?
  packagingCost          Float?
  liningCost             Float?
  laborMinutes           Float?
  shopifySourceProductId String?
  shopifySourceHandle    String?
  skus                   Sku[]
  fabric                 Fabric  @relation(fields: [fabricId], references: [id])
  product                Product @relation(fields: [productId], references: [id])
  bomLines               VariationBomLine[] // NEW: BOM overrides for this variation

  @@unique([productId, colorName])
  @@index([productId])
  @@index([fabricId])
  @@index([shopifySourceProductId])
}

model Sku {
  id                     String                        @id @default(uuid())
  skuCode                String                        @unique
  variationId            String
  size                   String
  fabricConsumption      Float                         @default(1.5)
  mrp                    Float
  targetStockQty         Int                           @default(10)
  targetStockMethod      String                        @default("day14")
  isActive               Boolean                       @default(true)
  shopifyInventoryItemId String?
  shopifyVariantId       String?
  exchangeCount          Int                           @default(0)
  returnCount            Int                           @default(0)
  writeOffCount          Int                           @default(0)
  customizationCount     Int                           @default(0)
  customizationNotes     String?
  customizationType      String?
  customizationValue     String?
  isCustomSku            Boolean                       @default(false)
  linkedOrderLineId      String?                       @unique
  parentSkuId            String?
  trimsCost              Float?
  packagingCost          Float?
  liningCost             Float?
  laborMinutes           Float?
  feedbackProductLinks   FeedbackProductLink[]
  reconciliationItems    InventoryReconciliationItem[]
  inventoryTransactions  InventoryTransaction[]
  orderLines             OrderLine[]
  productionBatches      ProductionBatch[]
  repackingQueueItems    RepackingQueueItem[]
  replacementItems       ReplacementItem[]
  exchangeRequestLines   ReturnRequestLine[]           @relation("ExchangeSku")
  returnRequestLines     ReturnRequestLine[]           @relation("ReturnedSku")
  shopifyInventoryCache  ShopifyInventoryCache?
  parentSku              Sku?                          @relation("CustomSkus", fields: [parentSkuId], references: [id])
  customSkus             Sku[]                         @relation("CustomSkus")
  variation              Variation                     @relation(fields: [variationId], references: [id])
  skuCosting             SkuCosting?
  writeOffLogs           WriteOffLog[]
  bomLines               SkuBomLine[]                  // NEW: BOM overrides for this SKU

  @@index([variationId])
  @@index([parentSkuId])
  @@index([isCustomSku])
}

model SkuCosting {
  skuId           String   @id
  fabricCost      Float
  laborTimeMins   Int
  laborRatePerMin Float
  laborCost       Float
  packagingCost   Float    @default(0)
  otherCost       Float    @default(0)
  totalCogs       Float
  lastUpdated     DateTime @default(now())
  sku             Sku      @relation(fields: [skuId], references: [id])
}

model CostConfig {
  id                   String   @id @default(uuid())
  laborRatePerMin      Float    @default(2.50)
  defaultPackagingCost Float    @default(50)
  lastUpdated          DateTime @default(now())
  gstRateAbove         Float    @default(18)
  gstRateBelow         Float    @default(5)
  gstThreshold         Float    @default(2500)
}

model FabricType {
  id                  String    @id @default(uuid())
  name                String    @unique
  composition         String?
  unit                String
  avgShrinkagePct     Float     @default(0)
  defaultCostPerUnit  Float?
  defaultLeadTimeDays Int?
  defaultMinOrderQty  Float?
  fabrics             Fabric[]
  products            Product[]
}

// ============================================
// MATERIAL HIERARCHY (NEW - 3-tier system)
// ============================================

// Level 1: Base fiber/material (replaces FabricType conceptually)
model Material {
  id          String   @id @default(uuid())
  name        String   @unique // "Linen", "Pima Cotton", "Cotton", "Utility"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fabrics     Fabric[] @relation("MaterialFabrics")
}

// Level 3: Color variant (the actual inventory item)
model FabricColour {
  id             String   @id @default(uuid())
  fabricId       String
  colourName     String   // "Navy Blue", "Rust", "Natural"
  standardColour String?  // Normalized: "blue", "red", "beige"
  colourHex      String?

  // Cost/supply overrides (null = inherit from Fabric)
  costPerUnit    Float?
  supplierId     String?
  leadTimeDays   Int?
  minOrderQty    Float?

  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  fabric         Fabric   @relation("FabricColours", fields: [fabricId], references: [id])
  supplier       Supplier? @relation("FabricColourSupplier", fields: [supplierId], references: [id])

  // BOM usages
  variationBomLines VariationBomLine[]
  skuBomLines       SkuBomLine[]

  @@unique([fabricId, colourName])
  @@index([fabricId])
  @@index([supplierId])
  @@index([fabricId, isActive]) // Composite index for active colours per fabric
}

model Fabric {
  id                  String                     @id @default(uuid())
  fabricTypeId        String
  name                String
  colorName           String
  standardColor       String?
  colorHex            String?
  costPerUnit         Float?
  supplierId          String?
  leadTimeDays        Int?
  minOrderQty         Float?
  isActive            Boolean                    @default(true)

  // NEW: Material hierarchy fields (optional for migration)
  materialId          String?                    // Link to new Material model
  constructionType    String?                    // "knit", "woven"
  pattern             String?                    // "single_jersey", "french_terry", "twill", "plain"
  weight              Float?                     // 180 (for gsm), 40 (for lea)
  weightUnit          String?                    // "gsm", "lea", "oz"
  composition         String?                    // "100% Cotton", "55% Linen 45% Cotton"
  avgShrinkagePct     Float?                     // Shrinkage percentage
  defaultLeadTimeDays Int?                       // Default lead time for colours
  defaultMinOrderQty  Float?                     // Default min order for colours
  unit                String?                    // "meters", "yards"

  fabricType          FabricType                 @relation(fields: [fabricTypeId], references: [id])
  supplier            Supplier?                  @relation(fields: [supplierId], references: [id])
  material            Material?                  @relation("MaterialFabrics", fields: [materialId], references: [id])
  fabricOrders        FabricOrder[]
  reconciliationItems FabricReconciliationItem[]
  transactions        FabricTransaction[]
  variations          Variation[]
  colours             FabricColour[]             @relation("FabricColours")

  @@unique([materialId, name]) // Prevent duplicate fabric names under the same material
  @@index([fabricTypeId])
  @@index([supplierId])
  @@index([materialId])
  @@index([constructionType])
  @@index([pattern])
}

model Supplier {
  id                 String              @id @default(uuid())
  name               String              @unique // Prevent duplicate supplier names
  contactName        String?
  email              String?
  phone              String?
  address            String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  fabrics            Fabric[]
  fabricOrders       FabricOrder[]
  fabricTransactions FabricTransaction[]
  fabricColours      FabricColour[]      @relation("FabricColourSupplier")
  trimItems          TrimItem[]          @relation("TrimSupplier")
}

model FabricTransaction {
  id          String    @id @default(uuid())
  fabricId    String
  txnType     String
  qty         Float
  unit        String
  reason      String
  costPerUnit Float?
  supplierId  String?
  referenceId String?
  notes       String?
  createdById String
  createdAt   DateTime  @default(now())
  createdBy   User      @relation(fields: [createdById], references: [id])
  fabric      Fabric    @relation(fields: [fabricId], references: [id])
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  @@index([fabricId])
  @@index([txnType])
  @@index([createdAt])
  @@index([fabricId, createdAt])
  @@index([supplierId])  // FK index for supplier reports
  @@index([createdById]) // FK index for user activity tracking
}

model FabricOrder {
  id           String    @id @default(uuid())
  fabricId     String
  supplierId   String
  qtyOrdered   Float
  unit         String
  costPerUnit  Float
  totalCost    Float
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  qtyReceived  Float?
  status       String    @default("ordered")
  notes        String?
  fabric       Fabric    @relation(fields: [fabricId], references: [id])
  supplier     Supplier  @relation(fields: [supplierId], references: [id])

  @@index([fabricId])
  @@index([supplierId])
  @@index([status])
}

model InventoryTransaction {
  id                String   @id @default(uuid())
  skuId             String
  txnType           String
  qty               Int
  reason            String
  referenceId       String?
  notes             String?
  warehouseLocation String?
  createdById       String
  createdAt         DateTime @default(now())
  createdBy         User     @relation(fields: [createdById], references: [id])
  sku               Sku      @relation(fields: [skuId], references: [id])

  @@index([skuId])
  @@index([txnType])
  @@index([createdAt])
  @@index([skuId, reason, createdAt])
  @@index([skuId, txnType])
  @@index([referenceId])
}

model Customer {
  id                String          @id @default(uuid())
  shopifyCustomerId String?         @unique
  email             String          @unique
  phone             String?
  firstName         String?
  lastName          String?
  defaultAddress    String?
  tags              String?
  acceptsMarketing  Boolean         @default(false)
  firstOrderDate    DateTime?
  lastOrderDate     DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  exchangeCount     Int             @default(0)
  returnCount       Int             @default(0)
  rtoCount          Int             @default(0)
  orderCount        Int             @default(0)  // Denormalized count of non-cancelled orders (for fast stats lookup)
  tier              String          @default("bronze")
  ltv               Int             @default(0)  // Stored LTV, updated incrementally on order changes
  feedback          Feedback[]
  orders            Order[]
  returnRequests    ReturnRequest[]

  @@index([createdAt])
}

model Order {
  id                   String             @id @default(uuid())
  orderNumber          String             @unique
  shopifyOrderId       String?            @unique
  channel              String             @default("shopify")
  customerId           String?
  customerName         String
  customerEmail        String?
  customerPhone        String?
  shippingAddress      String?
  orderDate            DateTime           @default(now())
  internalNotes        String?
  paymentMethod        String?
  status               String             @default("open")
  isArchived           Boolean            @default(false)
  archivedAt           DateTime?
  releasedToShipped    Boolean            @default(false)
  releasedToCancelled  Boolean            @default(false)
  // @deprecated Use OrderLine.awbNumber - kept for backward compat, may have different AWBs per line
  awbNumber            String?
  // @deprecated Use OrderLine.courier - kept for backward compat, may have different couriers per line
  courier              String?
  // @deprecated Use OrderLine.shippedAt - kept for backward compat, lines may ship at different times
  shippedAt            DateTime?
  // @deprecated Use OrderLine.deliveredAt - kept for backward compat, lines may deliver at different times
  deliveredAt          DateTime?
  totalAmount          Float
  createdAt            DateTime           @default(now())
  syncedAt             DateTime?
  // @deprecated Use OrderLine.rtoInitiatedAt - kept for backward compat, RTO is line-level
  rtoInitiatedAt       DateTime?
  // @deprecated Use OrderLine.rtoReceivedAt - kept for backward compat, RTO receipt is line-level
  rtoReceivedAt        DateTime?
  courierStatusCode    String?
  deliveryAttempts     Int                @default(0)
  expectedDeliveryDate DateTime?
  lastScanAt           DateTime?
  lastScanLocation     String?
  lastScanStatus       String?
  lastTrackingUpdate   DateTime?
  trackingStatus       String?
  codRemittanceUtr     String?
  codRemittedAmount    Float?
  codRemittedAt        DateTime?
  codShopifySyncError  String?
  codShopifySyncStatus String?
  codShopifySyncedAt   DateTime?
  holdAt               DateTime?
  holdNotes            String?
  holdReason           String?
  isOnHold             Boolean            @default(false)
  isExchange           Boolean            @default(false)
  originalOrderId      String?
  shipByDate           DateTime?
  terminalAt           DateTime?
  terminalStatus       String?
  partiallyCancelled   Boolean            @default(false)
  paymentConfirmedAt   DateTime?
  paymentConfirmedBy   String?
  paymentStatus        String?            @default("pending")
  customer             Customer?          @relation(fields: [customerId], references: [id])
  shopifyCache         ShopifyOrderCache? @relation(fields: [shopifyOrderId], references: [id])
  orderLines           OrderLine[]
  payments             OrderPayment[]     // Payment transactions for this order
  returnRequests       ReturnRequest[]    @relation("OriginalOrder")
  exchangeRequests     ReturnRequest[]    @relation("ExchangeOrder")
  originalOrder        Order?             @relation("ExchangeOriginalOrder", fields: [originalOrderId], references: [id])
  exchangeOrders       Order[]            @relation("ExchangeOriginalOrder")

  @@index([customerId])
  @@index([status])
  @@index([orderDate])
  @@index([isArchived])
  @@index([isExchange])
  @@index([originalOrderId])
  @@index([shipByDate])
  @@index([paymentStatus])
  @@index([paymentMethod, paymentStatus]) // Compound: filter by payment method + status
  @@index([status, orderDate])      // Compound: filter by status + sort by date
  @@index([customerId, orderDate])  // Compound: customer order history
  @@index([status, isArchived])     // Compound: open orders query (status='open', isArchived=false)
  @@index([status, isArchived, orderDate]) // Compound: open orders with date sort
  @@index([terminalStatus])         // Terminal status filtering
  @@index([terminalAt])             // Terminal date filtering for archive
  @@index([terminalStatus, terminalAt]) // Compound: archive queue queries
  @@index([shippedAt])              // Shipped orders sorting
  @@index([status, shippedAt])      // Compound: shipped view filtering
  @@index([isArchived, releasedToShipped]) // Compound: open view filtering
  @@index([isArchived, releasedToShipped, orderDate]) // Compound: open view with date sort
  @@index([isArchived, releasedToCancelled]) // Compound: cancelled view filtering
  // Performance: Tracking and COD views
  @@index([trackingStatus, isArchived]) // RTO view filtering
  @@index([paymentMethod, trackingStatus, codRemittedAt]) // COD pending view
  // Performance: 3-way view filtering and customer payment tracking
  @@index([status, terminalStatus, isArchived]) // 3-way view filter
  @@index([customerId, paymentStatus]) // Customer payment tracking
}

// ============================================
// ORDER PAYMENTS
// ============================================

model OrderPayment {
  id             String   @id @default(uuid())
  orderId        String
  amount         Float    // Payment amount in ₹
  paymentMethod  String?  // cash, bank_transfer, upi, card, cheque, etc.
  reference      String?  // Transaction ID, UTR, receipt number, cheque number
  notes          String?  // Additional notes about this payment
  recordedById   String   // User who recorded this payment
  recordedAt     DateTime @default(now())
  createdAt      DateTime @default(now())

  order      Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  recordedBy User  @relation(fields: [recordedById], references: [id])

  @@index([orderId])
  @@index([recordedAt])
  @@index([orderId, recordedAt]) // Compound: payment history for order
  @@index([recordedById])        // FK index for user lookups
}

model OrderLine {
  id                 String              @id @default(uuid())
  orderId            String
  shopifyLineId      String?
  skuId              String
  qty                Int
  unitPrice          Float
  lineStatus         String              @default("pending")
  allocatedAt        DateTime?
  pickedAt           DateTime?
  packedAt           DateTime?
  shippedAt          DateTime?
  inventoryTxnId     String?
  productionBatchId  String?
  notes              String?
  rtoCondition       String?
  rtoInwardedAt      DateTime?
  rtoInwardedById    String?
  rtoNotes           String?
  customizedAt       DateTime?
  customizedById     String?
  isCustomized       Boolean             @default(false)
  isNonReturnable    Boolean             @default(false)
  originalSkuId      String?
  awbNumber          String?
  courier            String?
  deliveredAt        DateTime?
  holdAt             DateTime?
  holdNotes          String?
  holdReason         String?
  isOnHold           Boolean             @default(false)
  lastTrackingUpdate DateTime?
  refundAmount       Float?
  refundNotes        String?
  refundReason       String?
  refundedAt         DateTime?
  rtoInitiatedAt     DateTime?
  rtoReceivedAt      DateTime?
  trackingStatus     String?
  shippingAddress    String?
  customizedBy       User?               @relation("CustomizedBy", fields: [customizedById], references: [id])
  order              Order               @relation(fields: [orderId], references: [id])
  productionBatch    ProductionBatch?    @relation(fields: [productionBatchId], references: [id])
  rtoInwardedBy      User?               @relation("RtoInwardedBy", fields: [rtoInwardedById], references: [id])
  sku                Sku                 @relation(fields: [skuId], references: [id])
  repackingQueueItems RepackingQueueItem[] @relation("OrderLineToRepacking")
  returnRequestLines ReturnRequestLine[]


  @@index([orderId])
  @@index([skuId])
  @@index([lineStatus])
  @@index([productionBatchId])
  @@index([lineStatus, orderId])
  @@index([rtoInwardedById])
  @@index([customizedById])
  @@index([awbNumber])
  @@index([skuId, rtoCondition])
  @@index([orderId, rtoCondition])
  // Performance: Line queries with SKU
  @@index([lineStatus, skuId]) // Status + SKU lookups for inventory
  @@index([skuId, lineStatus]) // SKU-first queries
  // Performance: View filtering and allocation queries
  @@index([orderId, lineStatus, shippedAt]) // View filtering with date
  @@index([awbNumber, courier]) // Tracking batch lookups
  @@index([lineStatus, allocatedAt]) // Analytics and allocation tracking
}

model ReturnRequest {
  id                  String                @id @default(uuid())
  requestNumber       String                @unique
  requestType         String
  originalOrderId     String
  customerId          String?
  status              String                @default("pending_pickup")
  reasonCategory      String
  reasonDetails       String?
  resolutionNotes     String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  exchangeOrderId     String?
  forwardDelivered    Boolean               @default(false)
  forwardDeliveredAt  DateTime?
  reverseReceived     Boolean               @default(false)
  reverseReceivedAt   DateTime?
  forwardShippedAt    DateTime?
  paymentAmount       Float?
  paymentCollectedAt  DateTime?
  refundAmount        Float?
  refundProcessedAt   DateTime?
  replacementValue    Float?
  resolution          String                @default("refund")
  returnValue         Float?
  reverseInTransitAt  DateTime?
  valueDifference     Float?
  repackingQueueItems RepackingQueueItem[]
  replacementItems    ReplacementItem[]
  customer            Customer?             @relation(fields: [customerId], references: [id])
  exchangeOrder       Order?                @relation("ExchangeOrder", fields: [exchangeOrderId], references: [id])
  originalOrder       Order                 @relation("OriginalOrder", fields: [originalOrderId], references: [id])
  lines               ReturnRequestLine[]
  shipping            ReturnShipping[]
  statusHistory       ReturnStatusHistory[]

  @@index([originalOrderId])
  @@index([customerId])
  @@index([status])
  @@index([resolution])
  @@index([exchangeOrderId])
  @@index([status, createdAt])
  @@index([customerId, status])
}

model ReturnRequestLine {
  id                  String        @id @default(uuid())
  requestId           String
  originalOrderLineId String?
  skuId               String
  qty                 Int
  exchangeSkuId       String?
  exchangeQty         Int?
  itemCondition       String?
  inspectionNotes     String?
  unitPrice           Float?
  exchangeSku         Sku?          @relation("ExchangeSku", fields: [exchangeSkuId], references: [id])
  originalOrderLine   OrderLine?    @relation(fields: [originalOrderLineId], references: [id])
  request             ReturnRequest @relation(fields: [requestId], references: [id])
  sku                 Sku           @relation("ReturnedSku", fields: [skuId], references: [id])

  @@index([requestId])
  @@index([skuId])
  @@index([skuId, itemCondition])
  @@index([originalOrderLineId]) // FK index for return processing
  @@index([exchangeSkuId])       // FK index for exchange lookups
}

model ReplacementItem {
  id        String        @id @default(uuid())
  requestId String
  skuId     String
  qty       Int
  unitPrice Float
  request   ReturnRequest @relation(fields: [requestId], references: [id])
  sku       Sku           @relation(fields: [skuId], references: [id])

  @@index([requestId])
  @@index([skuId])
}

model ReturnShipping {
  id                String        @id @default(uuid())
  requestId         String
  direction         String
  courier           String?
  awbNumber         String?
  pickupAddress     String?
  pickupScheduledAt DateTime?
  pickedUpAt        DateTime?
  receivedAt        DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  status            String        @default("scheduled")
  notes             String?
  request           ReturnRequest @relation(fields: [requestId], references: [id])

  @@index([requestId])
}

model ReturnStatusHistory {
  id          String        @id @default(uuid())
  requestId   String
  fromStatus  String
  toStatus    String
  changedById String
  notes       String?
  createdAt   DateTime      @default(now())
  changedBy   User          @relation(fields: [changedById], references: [id])
  request     ReturnRequest @relation(fields: [requestId], references: [id])

  @@index([requestId])
  @@index([changedById]) // FK index for audit queries
}

model Feedback {
  id           String                @id @default(uuid())
  customerId   String?
  orderId      String?
  orderLineId  String?
  source       String
  feedbackType String
  status       String                @default("new")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  customer     Customer?             @relation(fields: [customerId], references: [id])
  content      FeedbackContent?
  media        FeedbackMedia[]
  productLinks FeedbackProductLink[]
  ratings      FeedbackRating[]
  tags         FeedbackTag[]

  @@index([customerId])
  @@index([status])
}

model FeedbackRating {
  id         String   @id @default(uuid())
  feedbackId String
  dimension  String
  score      Int
  feedback   Feedback @relation(fields: [feedbackId], references: [id])

  @@index([feedbackId]) // FK index
}

model FeedbackContent {
  id             String   @id @default(uuid())
  feedbackId     String   @unique
  title          String?
  body           String?
  pros           String?
  cons           String?
  wouldRecommend Boolean?
  feedback       Feedback @relation(fields: [feedbackId], references: [id])
}

model FeedbackMedia {
  id         String   @id @default(uuid())
  feedbackId String
  mediaType  String
  url        String
  caption    String?
  feedback   Feedback @relation(fields: [feedbackId], references: [id])

  @@index([feedbackId]) // FK index
}

model FeedbackProductLink {
  id          String   @id @default(uuid())
  feedbackId  String
  productId   String?
  variationId String?
  skuId       String?
  feedback    Feedback @relation(fields: [feedbackId], references: [id])
  sku         Sku?     @relation(fields: [skuId], references: [id])

  @@index([feedbackId])  // FK index
  @@index([productId])   // FK index for product lookup
  @@index([variationId]) // FK index for variation lookup
}

model FeedbackTag {
  id         String   @id @default(uuid())
  feedbackId String
  tag        String
  feedback   Feedback @relation(fields: [feedbackId], references: [id])

  @@index([feedbackId]) // FK index
}

model Tailor {
  id                String            @id @default(uuid())
  name              String            @unique // Prevent duplicate tailor names
  specializations   String?
  dailyCapacityMins Int               @default(480)
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  productionBatches ProductionBatch[]
}

model ProductionBatch {
  id                String      @id @default(uuid())
  batchCode         String?     @unique
  batchDate         DateTime    @default(now())
  tailorId          String?
  skuId             String?     // Nullable for sample batches
  sampleCode        String?     @unique  // SAMPLE-01, SAMPLE-02, etc.
  sampleName        String?     // Description of sample item
  sampleColour      String?     // Colour for sample item
  sampleSize        String?     // Size for sample item
  qtyPlanned        Int
  qtyCompleted      Int         @default(0)
  priority          String
  sourceOrderLineId String?
  status            String      @default("planned")
  notes             String?
  createdAt         DateTime    @default(now())
  completedAt       DateTime?
  orderLines        OrderLine[]
  sku               Sku?        @relation(fields: [skuId], references: [id])  // Optional for samples
  tailor            Tailor?     @relation(fields: [tailorId], references: [id])

  @@index([skuId])
  @@index([tailorId])
  @@index([batchDate])
  @@index([status])
  @@index([batchDate, batchCode])
  @@index([skuId, status])
}

model RepackingQueueItem {
  id              String         @id @default(uuid())
  skuId           String
  qty             Int            @default(1)
  returnRequestId String?
  returnLineId    String?
  status          String         @default("pending")
  condition       String
  inspectionNotes String?
  writeOffReason  String?
  createdAt       DateTime       @default(now())
  processedAt     DateTime?
  processedById   String?
  qcComments      String?
  orderLineId     String?
  processedBy     User?          @relation("RepackingProcessor", fields: [processedById], references: [id])
  orderLine       OrderLine?     @relation("OrderLineToRepacking", fields: [orderLineId], references: [id])


  returnRequest   ReturnRequest? @relation(fields: [returnRequestId], references: [id])
  sku             Sku            @relation(fields: [skuId], references: [id])

  @@index([skuId])
  @@index([status])
  @@index([returnRequestId])
  @@index([orderLineId])
  @@index([skuId, status])
}

model WriteOffLog {
  id          String   @id @default(uuid())
  skuId       String
  qty         Int
  reason      String
  sourceType  String
  sourceId    String?
  notes       String?
  costValue   Float?
  createdById String
  createdAt   DateTime @default(now())
  createdBy   User     @relation("WriteOffCreator", fields: [createdById], references: [id])
  sku         Sku      @relation(fields: [skuId], references: [id])

  @@index([skuId])
  @@index([reason])
  @@index([createdAt])
}

model ShopifyInventoryCache {
  skuId                  String   @id
  shopifyInventoryItemId String
  availableQty           Int
  lastSynced             DateTime @default(now())
  sku                    Sku      @relation(fields: [skuId], references: [id])
}

model ShopifyProductCache {
  id              String    @id
  rawData         String
  title           String?
  handle          String?
  lastWebhookAt   DateTime  @default(now())
  webhookTopic    String?
  processedAt     DateTime?
  processingError String?
  createdAt       DateTime  @default(now())

  @@index([handle])
  @@index([processedAt])
  @@index([lastWebhookAt])
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model SyncJob {
  id              String    @id @default(uuid())
  jobType         String
  status          String    @default("pending")
  dateFilter      String?
  daysBack        Int?
  syncMode        String?
  staleAfterMins  Int?
  totalRecords    Int?
  processed       Int       @default(0)
  created         Int       @default(0)
  updated         Int       @default(0)
  skipped         Int       @default(0)
  errors          Int       @default(0)
  lastProcessedId String?
  currentBatch    Int       @default(0)
  errorLog        String?
  lastError       String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([jobType])
  @@index([createdAt])
}

model ShopifyOrderCache {
  id                    String    @id
  rawData               String
  orderNumber           String?
  financialStatus       String?
  fulfillmentStatus     String?
  lastWebhookAt         DateTime  @default(now())
  webhookTopic          String?
  processedAt           DateTime?
  processingError       String?
  createdAt             DateTime  @default(now())
  customerNotes         String?
  discountCodes         String?
  paymentMethod         String?
  shippedAt             DateTime?
  shippingCity          String?
  shippingCountry       String?
  shippingState         String?
  tags                  String?
  trackingCompany       String?
  trackingNumber        String?
  trackingUrl           String?
  deliveredAt           DateTime?
  fulfillmentUpdatedAt  DateTime?
  shipmentStatus        String?
  processingLock        DateTime?
  billingCity           String?
  billingName           String?
  billingPhone          String?
  billingState          String?
  billingZip            String?
  buyerAcceptsMarketing Boolean?
  cancelReason          String?
  confirmationNumber    String?
  currency              String?
  customerEmail         String?
  customerFirstName     String?
  customerId            String?
  customerLastName      String?
  customerPhone         String?
  fulfillmentCount      Int?
  isConfirmed           Boolean?
  isTaxExempt           Boolean?
  isTest                Boolean?
  lineItemCount         Int?
  paymentGatewayNames   String?
  refundCount           Int?
  shippingAddress1      String?
  shippingAddress2      String?
  shippingCountryCode   String?
  shippingLatitude      Float?
  shippingLongitude     Float?
  shippingName          String?
  shippingPhone         String?
  shippingProvince      String?
  shippingProvinceCode  String?
  shippingZip           String?
  shopifyCancelledAt    DateTime?
  shopifyClosedAt       DateTime?
  shopifyCreatedAt      DateTime?
  shopifyOrderName      String?
  shopifyProcessedAt    DateTime?
  shopifyUpdatedAt      DateTime?
  sourceName            String?
  totalLineItemsPrice   Float?
  totalOutstanding      Float?
  totalShippingPrice    Float?
  totalPrice            Decimal?  @db.Decimal
  subtotalPrice         Decimal?  @db.Decimal
  totalTax              Decimal?  @db.Decimal
  totalDiscounts        Decimal?  @db.Decimal

  // Line item and order details (eliminates rawData parsing)
  lineItemsJson         String?   // [{id, sku, title, variant_title, price, quantity, discount_allocations}]
  shippingLinesJson     String?   // [{title, price}]
  taxLinesJson          String?   // [{title, price, rate}]
  noteAttributesJson    String?   // [{name, value}]

  // Missing billing address fields
  billingAddress1       String?
  billingAddress2       String?
  billingCountry        String?
  billingCountryCode    String?

  order                 Order?

  @@index([orderNumber])
  @@index([processedAt])
  @@index([lastWebhookAt])
}

model WebhookLog {
  id             String    @id @default(uuid())
  webhookId      String    @unique
  topic          String
  resourceId     String?
  status         String    @default("received")
  responseCode   Int?
  processingTime Int?
  error          String?
  payload        String?   // Raw webhook JSON payload (truncated for large payloads)
  resultData     String?   // JSON of DB changes: {action, orderId, orderNumber, linesCreated, etc.}
  receivedAt     DateTime  @default(now())
  processedAt    DateTime?

  @@index([webhookId])
  @@index([topic])
  @@index([resourceId])
  @@index([receivedAt])
}

model FailedSyncItem {
  id          String    @id @default(uuid())
  itemType    String
  resourceId  String
  rawData     String?
  error       String
  retryCount  Int       @default(0)
  maxRetries  Int       @default(5)
  nextRetryAt DateTime?
  status      String    @default("pending")
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([itemType, resourceId])
  @@index([status])
  @@index([nextRetryAt])
  @@index([itemType])
}

model FabricReconciliation {
  id            String                     @id @default(uuid())
  reconcileDate DateTime                   @default(now())
  status        String                     @default("draft")
  notes         String?
  createdBy     String?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  items         FabricReconciliationItem[]

  @@index([status])
  @@index([createdAt])
}

model FabricReconciliationItem {
  id               String               @id @default(uuid())
  reconciliationId String
  fabricId         String
  systemQty        Float
  physicalQty      Float?
  variance         Float?
  adjustmentReason String?
  notes            String?
  txnId            String?              @unique
  fabric           Fabric               @relation(fields: [fabricId], references: [id])
  reconciliation   FabricReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)

  @@index([reconciliationId])
  @@index([fabricId])
}

model InventoryReconciliation {
  id            String                        @id @default(uuid())
  reconcileDate DateTime                      @default(now())
  status        String                        @default("draft")
  notes         String?
  createdBy     String?
  createdAt     DateTime                      @default(now())
  updatedAt     DateTime                      @updatedAt
  items         InventoryReconciliationItem[]

  @@index([status])
  @@index([createdAt])
}

model InventoryReconciliationItem {
  id               String                  @id @default(uuid())
  reconciliationId String
  skuId            String
  systemQty        Int
  physicalQty      Int?
  variance         Int?
  adjustmentReason String?
  notes            String?
  txnId            String?                 @unique
  reconciliation   InventoryReconciliation @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
  sku              Sku                     @relation(fields: [skuId], references: [id])

  @@index([reconciliationId])
  @@index([skuId])
}

model Pincode {
  id        String   @id @default(uuid())
  pincode   String   @unique
  district  String
  state     String
  region    String?
  division  String?
  createdAt DateTime @default(now())

  @@index([state])
  @@index([district])
}

// ============================================
// VENDOR MODEL (for services)
// ============================================

model Vendor {
  id           String        @id @default(uuid())
  name         String        @unique // Prevent duplicate vendor names
  contactName  String?
  email        String?
  phone        String?
  address      String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  serviceItems ServiceItem[]
}

// ============================================
// CATALOG MODELS (TrimItem, ServiceItem)
// ============================================

model TrimItem {
  id            String   @id @default(uuid())
  code          String   @unique // "BTN-SHELL-18L"
  name          String            // "Shell Button 18L"
  category      String            // "button", "zipper", "elastic", "label", "thread"
  description   String?

  costPerUnit   Float
  unit          String   @default("piece") // "piece", "meter", "spool"

  supplierId    String?
  minOrderQty   Float?
  leadTimeDays  Int?

  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  supplier      Supplier? @relation("TrimSupplier", fields: [supplierId], references: [id])

  // BOM usages
  productBomTemplates ProductBomTemplate[]
  variationBomLines   VariationBomLine[]
  skuBomLines         SkuBomLine[]

  @@index([category])
  @@index([supplierId])
}

model ServiceItem {
  id           String   @id @default(uuid())
  code         String   @unique // "PRINT-BLOCK-INDIGO"
  name         String            // "Block Print - Indigo Floral"
  category     String            // "printing", "embroidery", "washing", "dyeing"
  description  String?

  costPerJob   Float             // Base cost per unit processed
  costUnit     String   @default("per_piece") // "per_piece", "per_meter"

  vendorId     String?
  leadTimeDays Int?

  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  vendor       Vendor?  @relation(fields: [vendorId], references: [id])

  // BOM usages
  productBomTemplates ProductBomTemplate[]
  variationBomLines   VariationBomLine[]
  skuBomLines         SkuBomLine[]

  @@index([category])
  @@index([vendorId])
}

// ============================================
// BOM COMPONENT TYPE DEFINITIONS
// ============================================

model ComponentType {
  id             String          @id @default(uuid())
  code           String          @unique // "FABRIC", "TRIM", "SERVICE"
  name           String                   // "Fabric", "Trim", "Service"
  trackInventory Boolean         @default(true) // false for SERVICE
  sortOrder      Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  roles          ComponentRole[]
}

model ComponentRole {
  id              String        @id @default(uuid())
  typeId          String
  code            String        // "main", "accent", "lining", "button", "print"
  name            String        // "Main Fabric", "Button", "Block Print"
  isRequired      Boolean       @default(false) // true for "main"
  allowMultiple   Boolean       @default(false) // true for some trims
  defaultQuantity Float?        // e.g., 7 for buttons
  defaultUnit     String?       // "meter", "piece", "job"
  sortOrder       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  type            ComponentType @relation(fields: [typeId], references: [id])

  // BOM usages
  productBomTemplates ProductBomTemplate[]
  variationBomLines   VariationBomLine[]
  skuBomLines         SkuBomLine[]

  @@unique([typeId, code])
  @@index([typeId])
}

// ============================================
// 3-LEVEL BOM SYSTEM
// ============================================

// Level 1: Product BOM Template (structure + defaults)
model ProductBomTemplate {
  id              String   @id @default(uuid())
  productId       String
  roleId          String   // ComponentRole.id

  // Component (optional at product level - fabric colors set at variation)
  trimItemId      String?  // Trims CAN be set here (same buttons for all colors)
  serviceItemId   String?  // Services CAN be set here (same print for all colors)
  // Note: fabricColourId NOT here - fabrics are color-specific, set at variation

  // Default quantity (inherited by variations and SKUs)
  defaultQuantity Float    @default(1)
  quantityUnit    String   @default("unit") // "meter", "piece", "job"
  wastagePercent  Float    @default(0)
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  role            ComponentRole @relation(fields: [roleId], references: [id])
  trimItem        TrimItem?     @relation(fields: [trimItemId], references: [id])
  serviceItem     ServiceItem?  @relation(fields: [serviceItemId], references: [id])

  @@unique([productId, roleId]) // One template per role per product
  @@index([productId])
  @@index([roleId])
}

// Level 2: Variation BOM Override (fabric colors + overrides)
model VariationBomLine {
  id             String   @id @default(uuid())
  variationId    String
  roleId         String   // ComponentRole.id

  // Component overrides (null = inherit from product template)
  fabricColourId String?  // REQUIRED for fabric roles (color-specific)
  trimItemId     String?  // Override trim if this variant uses different one
  serviceItemId  String?  // Override service if this variant uses different one

  // Quantity override (null = inherit from product template)
  quantity       Float?
  wastagePercent Float?
  notes          String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  variation      Variation     @relation(fields: [variationId], references: [id], onDelete: Cascade)
  role           ComponentRole @relation(fields: [roleId], references: [id])
  fabricColour   FabricColour? @relation(fields: [fabricColourId], references: [id])
  trimItem       TrimItem?     @relation(fields: [trimItemId], references: [id])
  serviceItem    ServiceItem?  @relation(fields: [serviceItemId], references: [id])

  @@unique([variationId, roleId]) // One line per role per variation
  @@index([variationId])
  @@index([roleId])
  @@index([fabricColourId])
}

// Level 3: SKU BOM Line (size-specific overrides)
model SkuBomLine {
  id             String   @id @default(uuid())
  skuId          String
  roleId         String   // ComponentRole.id

  // Component override (null = inherit from variation → product)
  fabricColourId String?  // Rare: specific SKU uses different fabric
  trimItemId     String?
  serviceItemId  String?

  // Quantity override (null = inherit from variation → product)
  quantity       Float?   // Common: XL uses more fabric
  wastagePercent Float?
  overrideCost   Float?   // Override catalog cost if needed
  notes          String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sku            Sku           @relation(fields: [skuId], references: [id], onDelete: Cascade)
  role           ComponentRole @relation(fields: [roleId], references: [id])
  fabricColour   FabricColour? @relation(fields: [fabricColourId], references: [id])
  trimItem       TrimItem?     @relation(fields: [trimItemId], references: [id])
  serviceItem    ServiceItem?  @relation(fields: [serviceItemId], references: [id])

  @@unique([skuId, roleId]) // One line per role per SKU
  @@index([skuId])
  @@index([roleId])
}
