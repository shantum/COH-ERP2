name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile
      - run: npx prisma generate
      - run: pnpm --filter @coh/shared build
      - run: pnpm typecheck
      - run: pnpm lint || true # TODO: fix 236 pre-existing lint errors, then remove || true
      - run: pnpm test

  deploy:
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            cd /app/COH-ERP2
            git checkout .
            git clean -fd --exclude=server/.env --exclude=node_modules --exclude=VERSION
            git pull origin main
            set -a && source server/.env && set +a
            pnpm install --frozen-lockfile
            npx prisma generate
            npx prisma migrate deploy --schema=prisma/schema.prisma
            cd shared && pnpm build && cd ..
            cd client && pnpm build && cd ..
            EXPECTED_COMMIT=$(git rev-parse --short HEAD)
            echo "$EXPECTED_COMMIT" > VERSION
            pm2 delete coh-erp || true
            pm2 start ecosystem.config.cjs
            sleep 5
            for i in 1 2 3 4 5; do
              RESPONSE=$(curl -s http://127.0.0.1:3001/api/health || true)
              STATUS=$(echo "$RESPONSE" | grep -o '"status":"ok"' || true)
              LIVE_COMMIT=$(echo "$RESPONSE" | grep -o '"commit":"[^"]*"' | cut -d'"' -f4 || true)
              if [ -n "$STATUS" ]; then
                if [ "$LIVE_COMMIT" = "$EXPECTED_COMMIT" ]; then
                  echo "Health check passed — commit $LIVE_COMMIT is live"
                  break
                else
                  echo "Health check passed but wrong commit: expected $EXPECTED_COMMIT, got $LIVE_COMMIT"
                  pm2 logs coh-erp --lines 30 --nostream
                  exit 1
                fi
              fi
              if [ "$i" = "5" ]; then
                echo "Health check failed after 5 attempts"
                pm2 logs coh-erp --lines 30 --nostream
                exit 1
              fi
              echo "Attempt $i: not ready, retrying in 3s..."
              sleep 3
            done
            bash scripts/slack-alert.sh success "Deploy Successful" "Deployed: \`$EXPECTED_COMMIT\` — $(git log -1 --format=%s)"

      - name: Notify Slack on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /app/COH-ERP2
            set -a && source server/.env && set +a
            bash scripts/slack-alert.sh error "Deploy Failed" "Failed deploying to Hetzner.\nCommit: \`$(git log -1 --oneline)\`\nCheck GitHub Actions for details."
