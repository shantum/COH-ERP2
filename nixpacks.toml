# Railway build configuration
[phases.setup]
nixPkgs = ["nodejs_22"]

[phases.install]
cmds = ["echo 'Skipping auto-install, handled in build phase'"]
dependsOn = ["setup"]

[phases.build]
cmds = [
  # Install root deps and generate Prisma client (shared brain pattern)
  "NODE_ENV=development npm install",
  # Generate Prisma client at root level (both client and kysely generators)
  "npx prisma generate",
  # Build shared types
  "cd shared && NODE_ENV=development npm ci && npx -y -p typescript tsc",
  # Build server (uses @prisma/client from root node_modules)
  "cd server && NODE_ENV=development npm ci",
  # Build client (uses @prisma/client from root node_modules via Node module resolution)
  "cd client && NODE_ENV=development npm ci && npm run build"
]
dependsOn = ["setup"]

[start]
# Run from root directory where prisma/ folder lives
cmd = "npx prisma migrate deploy --schema=prisma/schema.prisma && cd server && npx tsx src/production.js"

[variables]
NODE_ENV = "production"
