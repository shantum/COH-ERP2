# Railway build configuration
[phases.setup]
nixPkgs = ["nodejs_22"]

[phases.install]
cmds = ["echo 'Skipping auto-install, handled in build phase'"]
dependsOn = ["setup"]

[phases.build]
cmds = [
  # Install root deps (hoisted Prisma) - use npm install (not ci) to avoid cache mount conflict
  "NODE_ENV=development npm install",
  # Build shared types
  "cd shared && NODE_ENV=development npm ci && npx -y -p typescript tsc",
  # Build server and generate Prisma client (both client and kysely generators)
  "cd server && NODE_ENV=development npm ci && npx prisma generate",
  # Copy generated .prisma/client from server to root node_modules for client resolution
  "cp -r server/node_modules/.prisma node_modules/",
  # Build client (resolves @prisma/client from root node_modules via Node module resolution)
  "cd client && NODE_ENV=development npm ci && npm run build"
]
dependsOn = ["setup"]

[start]
cmd = "cd server && npx prisma migrate deploy && npx tsx src/production.js"

[variables]
NODE_ENV = "production"
