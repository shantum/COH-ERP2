# Railway build configuration
[phases.setup]
nixPkgs = ["nodejs_22"]

[phases.install]
cmds = ["echo 'Skipping auto-install, handled in build phase'"]
dependsOn = ["setup"]

[phases.build]
cmds = [
  "cd shared && NODE_ENV=development npm ci && npx -y -p typescript tsc",
  # Generate Prisma client in client dir (Server Functions run from client/dist)
  # Use --generator client to skip prisma-kysely which isn't installed in client
  "cd client && NODE_ENV=development npm ci && npx prisma generate --schema=../server/prisma/schema.prisma --generator client && npm run build",
  "cd server && NODE_ENV=development npm ci && npx prisma generate"
]
dependsOn = ["setup"]

[start]
cmd = "cd server && npx prisma migrate deploy && npx tsx src/production.js"

[variables]
NODE_ENV = "production"
